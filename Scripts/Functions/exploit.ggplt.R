#########################################################################################################################################
# This is an update on the exploitation plot created 
#########################################################################################################################################
# Revision history
## Created by DK in August of 2017


#####################################  Function Summary ########################################################
####  
##  This function is used within these files:(a.k.a "dependent files") 
##
##  1:  Update_function_JAGS.r
###############################################################################################################

###############################################################################################################
## This function needs these functions to work (a.k.a. "support files")
# 
##
###############################################################################################################


###############################################################################################################
# Arguments
#output:          The results from the assessment model
#years:           The years the model was run.
#var:             What variables do you want to add to this figure.  Default produces all of the possibly available
#                 mortality terms.  The "mu" gives fishing mortality (exploitation rate). 
#                 "M" and "MR" provides the clapper based natural mortality for the fully recruited and/or the recruits
#                 "nM" and "nMR" is any natural mortality that is not associated with the clapper index.  This is not part of the 
#                 the assessment model (as of Aug 2017), but a model with this included does exist at 
#                 (../Assessment_fns/Framework/2017/Catch_recruits/DDwSE3_catch_recruits_with_additional_non_clapper_natural_mortality.bug)
#cred.int:        The credible interval to plot.  Default = 0.95 which is the 95% credible interval.
#graphic:         The graphic device.  Default ="screen" which plots the the screen, optionally can save as a pdf.
#path:            The path to put the figure if saved as a pdf.  Default is blank
#plot.CI:         Add the confidence interval to the plots.  Can make things rather messy!
# Start the function

exploit.plt <- function(output, years, var=c('mu','M','MR','nM','nMR'),cred.int = 0.95,graphic="screen", path="",plot.CI = T)
{
require(ggplot2) || stop("You need the 'ggplot2' package to create this beautifully wondorous plot my friend")
require(viridis) || stop("You need the colourful 'viridis' package to create this beautifully wondorous plot my friend")
 # If years is not specified define years from the data.
if(missing(years)==T) years<-output$data$iyr
# If you want to make a pdf figure put it here.
if(graphic=='pdf') pdf(paste0(path,"mortality.pdf"), width = 11, height = 8.5)
# If just ploting to a window do it like this.
if(graphic=="screen")windows(11,8.5)

# The upper and lower credible limits bounds.
UB <- 1-(1-cred.int)/2 
LB <- (1-cred.int)/2 

# Now get the LCI/UCI and variable names so we can punch them into ggplot
LCI <- NULL
UCI <- NULL
vars <- rep(var[1],length(output$data$year))
# Take the first letter from each var to create a dummy variable for our plts
dummy <- rep(substr(var[1],1,1),length(output$data$year))
for(i in 1:length(var))
{
  LCI[[var[i]]] <- apply(do.call("rbind",output$sims.list[var[i]]),2,quantile,LB)
  UCI[[var[i]]] <- apply(do.call("rbind",output$sims.list[var[i]]),2,quantile,UB)
  if(i > 1) vars <- c(vars,rep(var[i],length(output$data$year)))
  if(i > 1) dummy <- c(dummy,rep(substr(var[i],1,1),length(output$data$year))) # used to bind the clapper mortality and the non-clapper mortality
} # end for(i in 1:length(var))

# Now make the dataframe with the variables we want
dat <- data.frame(year = rep(output$data$year,length(var)), mort = unlist(output$median[var]),
                  LCI = do.call("c",LCI), UCI = do.call("c",UCI), type = vars,dummy = dummy,stringsAsFactors = F)

# Give the variables nice names...
dat$dummy[dat$dummy == "n"] <- "Other mortality"
dat$dummy[dat$dummy == "M"] <- "Clapper Mortality"
dat$dummy[dat$dummy == "m"] <- "Fishing mortality"
dat$type[dat$type == "mu"] <- "Fishing mortality"
dat$type[dat$type == "M"] <- "Fully recruited clapper mortality"
dat$type[dat$type == "MR"] <- "Recruit clapper mortality"
dat$type[dat$type == "nM"] <- "Fully recruited other mortality"
dat$type[dat$type == "nMR"] <- "Recruit other mortality"

# Get some "nice" colors

# Subset to the years of interest.
dat <- dat[dat$year %in% years,]
  # And set up our ggplot
p <- ggplot(data=dat,aes(x = year,y = mort,colour=type)) + geom_line() + geom_point(aes(shape=type)) + facet_grid(~dummy) +
           scale_color_viridis(discrete = T,option = "B",begin=0.1,end=0.9) + xlab("") + ylab("Mortality") +
           scale_shape_manual(values=c(4,15:(13+length(var)))) + theme_bw(base_size = 18) + theme(panel.grid=element_blank()) 
# If you want to add the confidence intervals
if(plot.CI == T) p <- p + geom_ribbon(aes(ymin=LCI,ymax=UCI),alpha=0.1)      
# make the plot
print(p)
# Shut down the graphics device if started.
if(graphic=='pdf') dev.off()

}# end the function


